# This script is called during setup.
# You can use 'setup_module' to access the contents of the iob_soc_setup.py python module
import os
import shutil

# Find out correct test.expected filename
test_file_name='test'
#Check if setup with INIT_MEM (check if macro exists)
init_mem = next((i for i in setup_module.confs if i['name']=='INIT_MEM'), False)
if init_mem and init_mem['val']:
    test_file_name+='_initmem'
#Check if setup with USE_EXTMEM (check if macro exists)
ext_mem = next((i for i in setup_module.confs if i['name']=='USE_EXTMEM'), False)
if ext_mem and ext_mem['val']:
    test_file_name+='_extmem'
test_file_name+='.expected'

#Set USE_EXTMEM=1 in fpga_build.mk if system was setup with EXTMEM
with open(setup_module.build_dir+"/hardware/fpga/fpga_build.mk",'r') as file: contents = file.readlines()
contents.insert(0,"\n#Line below was auto generated by fpga_setup.py\n")
if ext_mem and ext_mem['val']: contents.insert(1,"USE_EXTMEM:=1\n\n")
else: contents.insert(1,"USE_EXTMEM:=0\n\n")
with open(setup_module.build_dir+"/hardware/fpga/fpga_build.mk",'w') as file: file.writelines(contents)


board_dirs = ['hardware/fpga/quartus/DE10-LITE/','hardware/fpga/quartus/CYCLONEV-GT-DK','hardware/fpga/vivado/AES-KU040-DB-G','hardware/fpga/vivado/BASYS3']
# Remove all test*.expected files from boards, copy only the correct one
for board_dir in board_dirs:
    # Delete all test*.expected files from build_dir
    dirpath=os.path.join(setup_module.build_dir, board_dir)
    for file in os.listdir(dirpath):
        if file.startswith("test") and file.endswith(".expected"):
            os.remove(os.path.join(dirpath,file))

    # Copy correct test.expected file to build dir
    src_file = os.path.join(setup_module.setup_dir, board_dir, test_file_name)
    if os.path.isfile(src_file):
        shutil.copyfile(src_file,os.path.join(dirpath,"test.expected"))

